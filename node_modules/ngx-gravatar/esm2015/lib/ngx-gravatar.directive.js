/* eslint-disable @angular-eslint/directive-selector */
import { Directive, ElementRef, Input, Renderer2, } from '@angular/core';
import { NgxGravatarService } from './ngx-gravatar.service';
export class NgxGravatarDirective {
    constructor(elementRef, renderer, gravatarService) {
        this.elementRef = elementRef;
        this.renderer = renderer;
        this.gravatarService = gravatarService;
        this.style = {};
        this.initialized = false;
        this.defaultConfig = this.gravatarService.getDefaultConfig();
        // Listen for error when fetching custom src
        this.renderer.listen(this.elementRef.nativeElement, 'error', (event) => {
            if (!this.isGravatarUsed) {
                this.initializeAvatar(true); // Force using gravatar
            }
        });
    }
    ngOnInit() {
        this.initializeAvatar();
        this.initialized = true;
        this.isGravatarUsed = false;
    }
    ngOnChanges() {
        if (this.initialized) {
            this.initializeAvatar();
        }
    }
    /**
     * Set default values for user inputs if they are not provided
     */
    setDefaultValues() {
        this.size = this.computeSize();
        this.ratio =
            this.ratio === undefined ? this.defaultConfig.ratio : this.ratio;
        this.requestedSize = this.size * this.ratio;
        this.round =
            this.round === undefined ? this.defaultConfig.round : this.round;
        this.cornerRadius =
            this.cornerRadius === undefined
                ? this.defaultConfig.cornerRadius
                : this.cornerRadius;
        this.preferGravatar =
            this.preferGravatar === undefined
                ? this.defaultConfig.preferGravatar
                : this.preferGravatar;
    }
    /**
     * Initialize avatar.
     * Custom source has higher priority if preferGravatar is not set on.
     * Finally, set styles for the avatar.
     */
    initializeAvatar(forcedGravatar) {
        this.setDefaultValues();
        let url = '';
        if (this.preferGravatar || forcedGravatar) {
            url = this.gravatarService.generateGravatarUrl(this.email, this.md5Hash, this.requestedSize, this.rating, this.fallback);
            this.isGravatarUsed = true;
        }
        else {
            // this.preferGravatar == false
            if (this.src) {
                url = this.src;
            }
            else {
                // fallback to gravatar
                url = this.gravatarService.generateGravatarUrl(this.email, this.md5Hash, this.requestedSize, this.rating, this.fallback);
                this.isGravatarUsed = true;
            }
        }
        this.renderer.setProperty(this.elementRef.nativeElement, 'src', url);
        this.setStyle(this.avatarStyle());
    }
    /**
     * Compute the size of the avatar
     *
     * @return size
     */
    computeSize() {
        let size = this.size === undefined ? this.defaultConfig.size : this.size;
        if (this.style && this.style.width) {
            try {
                const width = this.style.width.trim();
                if (width.match(/^\d+px$/)) {
                    // width with px unit
                    size = width.replace('px', '');
                }
            }
            catch (e) {
                return size;
            }
        }
        return size;
    }
    /**
     * Compute style object
     *
     * @return style object
     */
    avatarStyle() {
        const style = {
            width: this.size + 'px',
            height: this.size + 'px',
            borderRadius: this.round
                ? this.defaultConfig.borderRadius
                : this.cornerRadius + 'px',
            borderStyle: this.defaultConfig.hasBorder || this.borderColor || this.borderWidth
                ? this.defaultConfig.borderStyle
                : 'none',
            borderColor: this.borderColor
                ? this.borderColor
                : this.defaultConfig.borderColor,
            borderWidth: this.borderWidth
                ? this.borderWidth + 'px'
                : this.defaultConfig.borderWidth + 'px',
            backgroundColor: this.backgroundColor
                ? this.backgroundColor
                : this.defaultConfig.backgroundColor,
        };
        return Object.assign(Object.assign({}, style), this.style);
    }
    /**
     * Set style for the avatar
     *
     * @param styles style object
     */
    setStyle(styles) {
        Object.keys(styles).forEach((key) => {
            this.renderer.setStyle(this.elementRef.nativeElement, key, styles[key]);
        });
    }
}
NgxGravatarDirective.decorators = [
    { type: Directive, args: [{
                selector: '[ngx-gravatar], [ngxGravatar]',
            },] }
];
NgxGravatarDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: Renderer2 },
    { type: NgxGravatarService }
];
NgxGravatarDirective.propDecorators = {
    src: [{ type: Input }],
    email: [{ type: Input }],
    md5Hash: [{ type: Input }],
    size: [{ type: Input }],
    fallback: [{ type: Input }],
    rating: [{ type: Input }],
    round: [{ type: Input }],
    cornerRadius: [{ type: Input }],
    borderColor: [{ type: Input }],
    borderWidth: [{ type: Input }],
    style: [{ type: Input }],
    preferGravatar: [{ type: Input }],
    backgroundColor: [{ type: Input }],
    ratio: [{ type: Input }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LWdyYXZhdGFyLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1ncmF2YXRhci9zcmMvbGliL25neC1ncmF2YXRhci5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsdURBQXVEO0FBQ3ZELE9BQU8sRUFDTCxTQUFTLEVBQ1QsVUFBVSxFQUNWLEtBQUssRUFHTCxTQUFTLEdBQ1YsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFNNUQsTUFBTSxPQUFPLG9CQUFvQjtJQXFCL0IsWUFDVSxVQUFzQixFQUN0QixRQUFtQixFQUNuQixlQUFtQztRQUZuQyxlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQ3RCLGFBQVEsR0FBUixRQUFRLENBQVc7UUFDbkIsb0JBQWUsR0FBZixlQUFlLENBQW9CO1FBYnBDLFVBQUssR0FBUSxFQUFFLENBQUM7UUFldkIsSUFBSSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUM7UUFDekIsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDN0QsNENBQTRDO1FBQzVDLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxFQUFFLE9BQU8sRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFO1lBQ3JFLElBQUksQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFO2dCQUN4QixJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyx1QkFBdUI7YUFDckQ7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxRQUFRO1FBQ04sSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDeEIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7UUFDeEIsSUFBSSxDQUFDLGNB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QUN6QyxlQUFlLEVBQUUsSUFBSSxDQUFDLGVBQWU7Z0JBQ25DLENBQUMsQ0FBQyxJQUFJLENBQUMsZUFBZTtnQkFDdEIsQ0FBQyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsZUFBZTtTQUN2QyxDQUFDO1FBQ0YsdUNBQVksS0FBSyxHQUFLLElBQUksQ0FBQyxLQUFLLEVBQUc7SUFDckMsQ0FBQztJQUVEOzs7O09BSUc7SUFDSyxRQUFRLENBQUMsTUFBVztRQUMxQixNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ2xDLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxFQUFFLEdBQUcsRUFBRSxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUMxRSxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7OztZQXZLRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLCtCQUErQjthQUMxQzs7O1lBWEMsVUFBVTtZQUlWLFNBQVM7WUFFRixrQkFBa0I7OztrQkFPeEIsS0FBSztvQkFDTCxLQUFLO3NCQUNMLEtBQUs7bUJBQ0wsS0FBSzt1QkFDTCxLQUFLO3FCQUNMLEtBQUs7b0JBQ0wsS0FBSzsyQkFDTCxLQUFLOzBCQUNMLEtBQUs7MEJBQ0wsS0FBSztvQkFDTCxLQUFLOzZCQUNMLEtBQUs7OEJBQ0wsS0FBSztvQkFDTCxLQUFLIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgQGFuZ3VsYXItZXNsaW50L2RpcmVjdGl2ZS1zZWxlY3RvciAqL1xuaW1wb3J0IHtcbiAgRGlyZWN0aXZlLFxuICBFbGVtZW50UmVmLFxuICBJbnB1dCxcbiAgT25DaGFuZ2VzLFxuICBPbkluaXQsXG4gIFJlbmRlcmVyMixcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBOZ3hHcmF2YXRhclNlcnZpY2UgfSBmcm9tICcuL25neC1ncmF2YXRhci5zZXJ2aWNlJztcbmltcG9ydCB7IEdyYXZhdGFyQ29uZmlnIH0gZnJvbSAnLi9ncmF2YXRhci1jb25maWcnO1xuXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6ICdbbmd4LWdyYXZhdGFyXSwgW25neEdyYXZhdGFyXScsXG59KVxuZXhwb3J0IGNsYXNzIE5neEdyYXZhdGFyRGlyZWN0aXZlIGltcGxlbWVudHMgT25DaGFuZ2VzLCBPbkluaXQge1xuICBASW5wdXQoKSBzcmM6IHN0cmluZztcbiAgQElucHV0KCkgZW1haWw6IHN0cmluZztcbiAgQElucHV0KCkgbWQ1SGFzaDogc3RyaW5nO1xuICBASW5wdXQoKSBzaXplOiBudW1iZXI7XG4gIEBJbnB1dCgpIGZhbGxiYWNrOiBzdHJpbmc7IC8vIGVudW06IFsnYmxhbmsnLCAnaWRlbnRpY29uJywgJ21tJywgJ21vbnN0ZXJpZCcsICdyZXRybycsICdyb2JvaGFzaCcsICd3YXZhdGFyJ11cbiAgQElucHV0KCkgcmF0aW5nOiBzdHJpbmc7IC8vIGVudW06IFsnZycsICdwZycsICdyJywgJ3gnXVxuICBASW5wdXQoKSByb3VuZDogYm9vbGVhbjtcbiAgQElucHV0KCkgY29ybmVyUmFkaXVzOiBudW1iZXI7XG4gIEBJbnB1dCgpIGJvcmRlckNvbG9yOiBzdHJpbmc7XG4gIEBJbnB1dCgpIGJvcmRlcldpZHRoOiBudW1iZXI7XG4gIEBJbnB1dCgpIHN0eWxlOiBhbnkgPSB7fTtcbiAgQElucHV0KCkgcHJlZmVyR3JhdmF0YXI6IGJvb2xlYW47XG4gIEBJbnB1dCgpIGJhY2tncm91bmRDb2xvcjogYm9vbGVhbjtcbiAgQElucHV0KCkgcmF0aW86IG51bWJlcjtcblxuICBpbml0aWFsaXplZDogYm9vbGVhbjtcbiAgZGVmYXVsdENvbmZpZzogR3JhdmF0YXJDb25maWc7XG4gIHJlcXVlc3RlZFNpemU6IG51bWJlcjtcbiAgaXNHcmF2YXRhclVzZWQ6IGJvb2xlYW47XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBlbGVtZW50UmVmOiBFbGVtZW50UmVmLFxuICAgIHByaXZhdGUgcmVuZGVyZXI6IFJlbmRlcmVyMixcbiAgICBwcml2YXRlIGdyYXZhdGFyU2VydmljZTogTmd4R3JhdmF0YXJTZXJ2aWNlXG4gICkge1xuICAgIHRoaXMuaW5pdGlhbGl6ZWQgPSBmYWxzZTtcbiAgICB0aGlzLmRlZmF1bHRDb25maWcgPSB0aGlzLmdyYXZhdGFyU2VydmljZS5nZXREZWZhdWx0Q29uZmlnKCk7XG4gICAgLy8gTGlzdGVuIGZvciBlcnJvciB3aGVuIGZldGNoaW5nIGN1c3RvbSBzcmNcbiAgICB0aGlzLnJlbmRlcmVyLmxpc3Rlbih0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgJ2Vycm9yJywgKGV2ZW50KSA9PiB7XG4gICAgICBpZiAoIXRoaXMuaXNHcmF2YXRhclVzZWQpIHtcbiAgICAgICAgdGhpcy5pbml0aWFsaXplQXZhdGFyKHRydWUpOyAvLyBGb3JjZSB1c2luZyBncmF2YXRhclxuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5pbml0aWFsaXplQXZhdGFyKCk7XG4gICAgdGhpcy5pbml0aWFsaXplZCA9IHRydWU7XG4gICAgdGhpcy5pc0dyYXZhdGFyVXNlZCA9IGZhbHNlO1xuICB9XG5cbiAgbmdPbkNoYW5nZXMoKSB7XG4gICAgaWYgKHRoaXMuaW5pdGlhbGl6ZWQpIHtcbiAgICAgIHRoaXMuaW5pdGlhbGl6ZUF2YXRhcigpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgZGVmYXVsdCB2YWx1ZXMgZm9yIHVzZXIgaW5wdXRzIGlmIHRoZXkgYXJlIG5vdCBwcm92aWRlZFxuICAgKi9cbiAgcHJpdmF0ZSBzZXREZWZhdWx0VmFsdWVzKCk6IHZvaWQge1xuICAgIHRoaXMuc2l6ZSA9IHRoaXMuY29tcHV0ZVNpemUoKTtcbiAgICB0aGlzLnJhdGlvID1cbiAgICAgIHRoaXMucmF0aW8gPT09IHVuZGVmaW5lZCA/IHRoaXMuZGVmYXVsdENvbmZpZy5yYXRpbyA6IHRoaXMucmF0aW87XG4gICAgdGhpcy5yZXF1ZXN0ZWRTaXplID0gdGhpcy5zaXplICogdGhpcy5yYXRpbztcbiAgICB0aGlzLnJvdW5kID1cbiAgICAgIHRoaXMucm91bmQgPT09IHVuZGVmaW5lZCA/IHRoaXMuZGVmYXVsdENvbmZpZy5yb3VuZCA6IHRoaXMucm91bmQ7XG4gICAgdGhpcy5jb3JuZXJSYWRpdXMgPVxuICAgICAgdGhpcy5jb3JuZXJSYWRpdXMgPT09IHVuZGVmaW5lZFxuICAgICAgICA/IHRoaXMuZGVmYXVsdENvbmZpZy5jb3JuZXJSYWRpdXNcbiAgICAgICAgOiB0aGlzLmNvcm5lclJhZGl1cztcbiAgICB0aGlzLnByZWZlckdyYXZhdGFyID1cbiAgICAgIHRoaXMucHJlZmVyR3JhdmF0YXIgPT09IHVuZGVmaW5lZFxuICAgICAgICA/IHRoaXMuZGVmYXVsdENvbmZpZy5wcmVmZXJHcmF2YXRhclxuICAgICAgICA6IHRoaXMucHJlZmVyR3JhdmF0YXI7XG4gIH1cblxuICAvKipcbiAgICogSW5pdGlhbGl6ZSBhdmF0YXIuXG4gICAqIEN1c3RvbSBzb3VyY2UgaGFzIGhpZ2hlciBwcmlvcml0eSBpZiBwcmVmZXJHcmF2YXRhciBpcyBub3Qgc2V0IG9uLlxuICAgKiBGaW5hbGx5LCBzZXQgc3R5bGVzIGZvciB0aGUgYXZhdGFyLlxuICAgKi9cbiAgcHJpdmF0ZSBpbml0aWFsaXplQXZhdGFyKGZvcmNlZEdyYXZhdGFyPzogYm9vbGVhbik6IHZvaWQge1xuICAgIHRoaXMuc2V0RGVmYXVsdFZhbHVlcygpO1xuICAgIGxldCB1cmwgPSAnJztcbiAgICBpZiAodGhpcy5wcmVmZXJHcmF2YXRhciB8fCBmb3JjZWRHcmF2YXRhcikge1xuICAgICAgdXJsID0gdGhpcy5ncmF2YXRhclNlcnZpY2UuZ2VuZXJhdGVHcmF2YXRhclVybChcbiAgICAgICAgdGhpcy5lbWFpbCxcbiAgICAgICAgdGhpcy5tZDVIYXNoLFxuICAgICAgICB0aGlzLnJlcXVlc3RlZFNpemUsXG4gICAgICAgIHRoaXMucmF0aW5nLFxuICAgICAgICB0aGlzLmZhbGxiYWNrXG4gICAgICApO1xuICAgICAgdGhpcy5pc0dyYXZhdGFyVXNlZCA9IHRydWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIHRoaXMucHJlZmVyR3JhdmF0YXIgPT0gZmFsc2VcbiAgICAgIGlmICh0aGlzLnNyYykge1xuICAgICAgICB1cmwgPSB0aGlzLnNyYztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIGZhbGxiYWNrIHRvIGdyYXZhdGFyXG4gICAgICAgIHVybCA9IHRoaXMuZ3JhdmF0YXJTZXJ2aWNlLmdlbmVyYXRlR3JhdmF0YXJVcmwoXG4gICAgICAgICAgdGhpcy5lbWFpbCxcbiAgICAgICAgICB0aGlzLm1kNUhhc2gsXG4gICAgICAgICAgdGhpcy5yZXF1ZXN0ZWRTaXplLFxuICAgICAgICAgIHRoaXMucmF0aW5nLFxuICAgICAgICAgIHRoaXMuZmFsbGJhY2tcbiAgICAgICAgKTtcbiAgICAgICAgdGhpcy5pc0dyYXZhdGFyVXNlZCA9IHRydWU7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMucmVuZGVyZXIuc2V0UHJvcGVydHkodGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQsICdzcmMnLCB1cmwpO1xuICAgIHRoaXMuc2V0U3R5bGUodGhpcy5hdmF0YXJTdHlsZSgpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb21wdXRlIHRoZSBzaXplIG9mIHRoZSBhdmF0YXJcbiAgICpcbiAgICogQHJldHVybiBzaXplXG4gICAqL1xuICBwcml2YXRlIGNvbXB1dGVTaXplKCk6IG51bWJlciB7XG4gICAgbGV0IHNpemUgPSB0aGlzLnNpemUgPT09IHVuZGVmaW5lZCA/IHRoaXMuZGVmYXVsdENvbmZpZy5zaXplIDogdGhpcy5zaXplO1xuICAgIGlmICh0aGlzLnN0eWxlICYmIHRoaXMuc3R5bGUud2lkdGgpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHdpZHRoID0gdGhpcy5zdHlsZS53aWR0aC50cmltKCk7XG4gICAgICAgIGlmICh3aWR0aC5tYXRjaCgvXlxcZCtweCQvKSkge1xuICAgICAgICAgIC8vIHdpZHRoIHdpdGggcHggdW5pdFxuICAgICAgICAgIHNpemUgPSB3aWR0aC5yZXBsYWNlKCdweCcsICcnKTtcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICByZXR1cm4gc2l6ZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHNpemU7XG4gIH1cblxuICAvKipcbiAgICogQ29tcHV0ZSBzdHlsZSBvYmplY3RcbiAgICpcbiAgICogQHJldHVybiBzdHlsZSBvYmplY3RcbiAgICovXG4gIHByaXZhdGUgYXZhdGFyU3R5bGUoKSB7XG4gICAgY29uc3Qgc3R5bGUgPSB7XG4gICAgICB3aWR0aDogdGhpcy5zaXplICsgJ3B4JyxcbiAgICAgIGhlaWdodDogdGhpcy5zaXplICsgJ3B4JyxcbiAgICAgIGJvcmRlclJhZGl1czogdGhpcy5yb3VuZFxuICAgICAgICA/IHRoaXMuZGVmYXVsdENvbmZpZy5ib3JkZXJSYWRpdXNcbiAgICAgICAgOiB0aGlzLmNvcm5lclJhZGl1cyArICdweCcsXG4gICAgICBib3JkZXJTdHlsZTpcbiAgICAgICAgdGhpcy5kZWZhdWx0Q29uZmlnLmhhc0JvcmRlciB8fCB0aGlzLmJvcmRlckNvbG9yIHx8IHRoaXMuYm9yZGVyV2lkdGhcbiAgICAgICAgICA/IHRoaXMuZGVmYXVsdENvbmZpZy5ib3JkZXJTdHlsZVxuICAgICAgICAgIDogJ25vbmUnLFxuICAgICAgYm9yZGVyQ29sb3I6IHRoaXMuYm9yZGVyQ29sb3JcbiAgICAgICAgPyB0aGlzLmJvcmRlckNvbG9yXG4gICAgICAgIDogdGhpcy5kZWZhdWx0Q29uZmlnLmJvcmRlckNvbG9yLFxuICAgICAgYm9yZGVyV2lkdGg6IHRoaXMuYm9yZGVyV2lkdGhcbiAgICAgICAgPyB0aGlzLmJvcmRlcldpZHRoICsgJ3B4J1xuICAgICAgICA6IHRoaXMuZGVmYXVsdENvbmZpZy5ib3JkZXJXaWR0aCArICdweCcsXG4gICAgICBiYWNrZ3JvdW5kQ29sb3I6IHRoaXMuYmFja2dyb3VuZENvbG9yXG4gICAgICAgID8gdGhpcy5iYWNrZ3JvdW5kQ29sb3JcbiAgICAgICAgOiB0aGlzLmRlZmF1bHRDb25maWcuYmFja2dyb3VuZENvbG9yLFxuICAgIH07XG4gICAgcmV0dXJuIHsgLi4uc3R5bGUsIC4uLnRoaXMuc3R5bGUgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgc3R5bGUgZm9yIHRoZSBhdmF0YXJcbiAgICpcbiAgICogQHBhcmFtIHN0eWxlcyBzdHlsZSBvYmplY3RcbiAgICovXG4gIHByaXZhdGUgc2V0U3R5bGUoc3R5bGVzOiBhbnkpIHtcbiAgICBPYmplY3Qua2V5cyhzdHlsZXMpLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZSh0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwga2V5LCBzdHlsZXNba2V5XSk7XG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==